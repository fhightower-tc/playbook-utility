#!/usr/bin/env python
# -*- coding: utf-8 -*-

import unittest
import html

from playbook_utility import playbook_utility
from .test_http_request_playbook_creation_ui import check_heading


class HttpRequestPlaybookCreationUiTestCase(unittest.TestCase):

    def setUp(self):
        self.app = playbook_utility.app.test_client()

    def test_converter_index(self):
        rv = self.app.get('/converter')
        check_heading(rv.data.decode())

    def test_empty_post_converter(self):
        rv = self.app.post('/converter/convert', data={'playbookContent': ''}, follow_redirects=True)
        assert "Please paste a playbook below to convert it to a component." in rv.data.decode()
        check_heading(rv.data.decode())

    def test_bad_json_post_converter(self):
        rv = self.app.post('/converter/convert', data={'playbookContent': 'abc'}, follow_redirects=True)
        assert "Error trying to parse the json for the playbook:" in rv.data.decode()
        check_heading(rv.data.decode())

    def test_converter(self):
        rv = self.app.post('/converter/convert', data={'playbookContent': '{"definitionVersion" : "1.0.0","name" : "simple pb","type" : "Standard","panX" : 20.0,"panY" : 20.0,"logLevel" : "WARN","description" : "test","jobList" : [ {"id" : 645,"appCatalogItem" : {"programName" : "Logger","displayName" : "Logger","programVersion" : "1.0.0","pipeRunLevel" : false},"name" : "Logger 1","jobParameterList" : [ {"appCatalogItemParameter" : {"paramName" : "log_message"},"value" : "abc"}, {"appCatalogItemParameter" : {"paramName" : "logging"},"value" : "INFO"} ],"locationLeft" : 390.0,"locationTop" : 220.0,"playbookRetryEnabled" : false}, {"id" : 646,"appCatalogItem" : {"programName" : "TCPB - HTTP Client v2.0","displayName" : "HTTP Client","programVersion" : "2.0.2","pipeRunLevel" : false},"name" : "HTTP Client 1","jobParameterList" : [ {"appCatalogItemParameter" : {"paramName" : "url"},"value" : "http://example.com"}, {"appCatalogItemParameter" : {"paramName" : "fail_on_error"},"value" : "true"}, {"appCatalogItemParameter" : {"paramName" : "body"}}, {"appCatalogItemParameter" : {"paramName" : "multipart"},"value" : "[]"}, {"appCatalogItemParameter" : {"paramName" : "verify_ssl"},"value" : "true"}, {"appCatalogItemParameter" : {"paramName" : "http_method"},"value" : "GET"}, {"appCatalogItemParameter" : {"paramName" : "headers"},"value" : "[]"}, {"appCatalogItemParameter" : {"paramName" : "params"},"value" : "[]"}, {"appCatalogItemParameter" : {"paramName" : "proxies_enabled"},"value" : "false"}, {"appCatalogItemParameter" : {"paramName" : "advanced"},"value" : "[]"} ],"locationLeft" : 620.0,"locationTop" : 220.0,"playbookRetryEnabled" : false,"playbookRetryDelayMinutes" : 1,"playbookRetryMaxRetries" : 5} ],"playbookConnectionList" : [ {"type" : "Pass","isCircularOnTarget" : false,"targetJobId" : 645,"sourceTriggerId" : 79}, {"type" : "Pass","isCircularOnTarget" : false,"sourceJobId" : 645,"targetJobId" : 646}, {"type" : "Pass","isCircularOnTarget" : true,"sourceJobId" : 646,"targetTriggerId" : 79} ],"playbookTriggerList" : [ {"id" : 79,"name" : "HttpLink Trigger 1","type" : "HttpLink","eventType" : "Create","locationLeft" : 160.0,"locationTop" : 220.0,"httpBasicAuthEnable" : false,"anyOrg" : true,"orFilters" : false,"fireOnDuplicate" : false,"renderBodyAsTip" : false} ],"exportablePipes" : [ ],"dateExported" : "2/16/18 12:26 AM"}'})
        assert '{&#34;definitionVersion&#34;: &#34;1.0.0&#34;, &#34;name&#34;: &#34;simple pb&#34;, &#34;type&#34;: &#34;Pipe&#34;, &#34;panX&#34;: 20.0, &#34;panY&#34;: 20.0, &#34;logLevel&#34;: &#34;WARN&#34;, &#34;description&#34;: &#34;test&#34;, &#34;jobList&#34;: [{&#34;id&#34;: 645, &#34;appCatalogItem&#34;: {&#34;programName&#34;: &#34;Logger&#34;, &#34;displayName&#34;: &#34;Logger&#34;, &#34;programVersion&#34;: &#34;1.0.0&#34;, &#34;pipeRunLevel&#34;: false}, &#34;name&#34;: &#34;Logger 1&#34;, &#34;jobParameterList&#34;: [{&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;log_message&#34;}, &#34;value&#34;: &#34;abc&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;logging&#34;}, &#34;value&#34;: &#34;INFO&#34;}], &#34;locationLeft&#34;: 390.0, &#34;locationTop&#34;: 220.0, &#34;playbookRetryEnabled&#34;: false}, {&#34;id&#34;: 646, &#34;appCatalogItem&#34;: {&#34;programName&#34;: &#34;TCPB - HTTP Client v2.0&#34;, &#34;displayName&#34;: &#34;HTTP Client&#34;, &#34;programVersion&#34;: &#34;2.0.2&#34;, &#34;pipeRunLevel&#34;: false}, &#34;name&#34;: &#34;HTTP Client 1&#34;, &#34;jobParameterList&#34;: [{&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;url&#34;}, &#34;value&#34;: &#34;http://example.com&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;fail_on_error&#34;}, &#34;value&#34;: &#34;true&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;body&#34;}}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;multipart&#34;}, &#34;value&#34;: &#34;[]&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;verify_ssl&#34;}, &#34;value&#34;: &#34;true&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;http_method&#34;}, &#34;value&#34;: &#34;GET&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;headers&#34;}, &#34;value&#34;: &#34;[]&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;params&#34;}, &#34;value&#34;: &#34;[]&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;proxies_enabled&#34;}, &#34;value&#34;: &#34;false&#34;}, {&#34;appCatalogItemParameter&#34;: {&#34;paramName&#34;: &#34;advanced&#34;}, &#34;value&#34;: &#34;[]&#34;}], &#34;locationLeft&#34;: 620.0, &#34;locationTop&#34;: 220.0, &#34;playbookRetryEnabled&#34;: false, &#34;playbookRetryDelayMinutes&#34;: 1, &#34;playbookRetryMaxRetries&#34;: 5}], &#34;playbookConnectionList&#34;: [{&#34;type&#34;: &#34;Pass&#34;, &#34;isCircularOnTarget&#34;: false, &#34;targetJobId&#34;: 645, &#34;sourceTriggerId&#34;: 1}, {&#34;type&#34;: &#34;Pass&#34;, &#34;isCircularOnTarget&#34;: false, &#34;sourceJobId&#34;: 645, &#34;targetJobId&#34;: 646}, {&#34;type&#34;: &#34;Pass&#34;, &#34;isCircularOnTarget&#34;: true, &#34;sourceJobId&#34;: 646, &#34;targetTriggerId&#34;: 1}], &#34;playbookTriggerList&#34;: [{&#34;id&#34;: 1, &#34;name&#34;: &#34;Component Trigger&#34;, &#34;type&#34;: &#34;PipeConfig&#34;, &#34;eventType&#34;: &#34;Create&#34;, &#34;httpBasicAuthEnable&#34;: false, &#34;anyOrg&#34;: true, &#34;orFilters&#34;: false, &#34;fireOnDuplicate&#34;: false, &#34;renderBodyAsTip&#34;: false, &#34;pipeInputParams&#34;: &#34;[{\&#34;label\&#34;:\&#34;b\&#34;,\&#34;dataType\&#34;:\&#34;String\&#34;,\&#34;playbookDataType\&#34;:\&#34;String\&#34;,\&#34;required\&#34;:false,\&#34;name\&#34;:\&#34;a\&#34;,\&#34;encrypted\&#34;:false,\&#34;hidden\&#34;:false,\&#34;hasDollarVariables\&#34;:false,\&#34;playbookVariable\&#34;:false,\&#34;validValuesList\&#34;:[\&#34;${TEXT}\&#34;,\&#34;${KEYCHAIN}\&#34;]}]&#34;, &#34;pipeOutputParams&#34;: &#34;[{\&#34;key\&#34;:\&#34;c\&#34;,\&#34;value\&#34;:\&#34;d\&#34;,\&#34;displayValue\&#34;:\&#34;d\&#34;}]&#34;}], &#34;exportablePipes&#34;: [], &#34;dateExported&#34;: &#34;2/16/18 12:26 AM&#34;}' in rv.data.decode()
        check_heading(rv.data.decode())
